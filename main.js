(()=>{"use strict";class s{constructor(s,t){this.container=s,this.input=t,this.showError=this.showError.bind(this),this.removeError=this.removeError.bind(this)}showError(s){this.error=document.createElement("div"),this.error.classList.add("error"),this.error.innerHTML=`\n      <div class="error__arrow"></div>\n      <div class="error__text">${s.reason}</div>\n    `;const{left:t,bottom:e}=this.input.getBoundingClientRect();this.error.style.left=window.scrollX+t-this.input.offsetWidth/3+"px",this.error.style.bottom=`${window.scrollY+e+25}px`,this.container.appendChild(this.error),this.input.addEventListener("focus",this.removeError)}removeError(){this.input.value="",this.error.remove()}}class t{constructor(s,t){this.container=s,this.server=t,this.showPopup()}showPopup(){this.popup=document.createElement("div"),this.popup.classList.add("popup"),this.popup.innerHTML='\n      <div class="popup__body">\n        <div class="popup__content">\n          <h3 class="popup__title">Выберите псевдоним</h3>\n          <form class="form">\n            <input type="text" class="form-group__field">\n            <div class="form__control">\n              <button class="form-control__button button button__save">Продолжить</button>\n            </div>\n          </form> \n        </div>\n      </div>\n    ',this.container.appendChild(this.popup),this.input=this.container.querySelector("input.form-group__field"),this.form=this.container.querySelector(".form"),this.error=new s(this.form,this.input),this.form.addEventListener("submit",this.onSubmit.bind(this)),this.onSubmit=this.onSubmit.bind(this)}onSubmit(s){s.preventDefault(),this.input.value?this.start():this.error.showError({reason:"Укажите никнейм"})}start(){this.ws=new WebSocket(this.server),this.ws.addEventListener("open",(()=>{this.ws.send(JSON.stringify({event:"login",message:this.input.value}))})),this.ws.addEventListener("message",(s=>{const t=JSON.parse(s.data);"connect"===t.event&&(this.usersList=t.message,this.container.dispatchEvent(new Event("connect")))})),this.ws.addEventListener("close",(s=>{1e3!==s.code&&this.check(),this.error.showError(s)}))}check(){this.ws&&3!==this.ws.readyState||this.start()}removePopup(){this.popup.remove()}}new class{constructor(s){this.container="string"==typeof s?document.querySelector(s):s,this.server="wss://ahj-chat-heroku.herokuapp.com//ws",this.users=this.container.querySelector(".chat__users"),this.messagebox=this.container.querySelector(".chat-messagebox__messages"),this.textarea=this.container.querySelector(".chat-messagebox__text"),this.login=new t(this.container,this.server),this.start=this.start.bind(this)}bindToDOM(){this.container.addEventListener("connect",this.start)}start(){this.nickname=this.login.input.value,this.chatUsers=this.login.usersList,this.reloadUsersList(),this.login.removePopup(),this.login.ws.addEventListener("message",(s=>{const t=JSON.parse(s.data);if("dialogue"===t.event){let s;this.nickname===t.message.nickname?(s=this.msgConstructor("Вы",t.message.date,t.message.text),s.classList.add("self")):s=this.msgConstructor(t.message.nickname,t.message.date,t.message.text),this.messagebox.appendChild(s),this.messagebox.scrollTop=this.messagebox.scrollHeight}"system"===t.event&&this.showSystemMsg(t)})),this.textarea.addEventListener("keydown",(s=>{"Enter"===s.key&&this.textarea.value.trim()&&this.sendMsg(s)}))}msgConstructor(s,t,e){const i=new Date(t),r=i.toLocaleTimeString().substring(0,5),n=i.toLocaleDateString(),o=document.createElement("div");return o.classList.add("chat-messagebox__message"),o.innerHTML=`\n        <div class="chat-message__info">${s}, ${r} ${n}</div>\n        <div class="chat-message__text">${e}</div>\n    `,o}sendMsg(s){s.preventDefault();const t=JSON.stringify({event:"dialogue",message:this.textarea.value});this.login.ws.send(t),this.textarea.value=""}showSystemMsg(s){if("login"===s.message.action&&this.nickname!==s.message.nickname)this.chatUsers.push(s.message.nickname);else if("logout"===s.message.action){const t=this.chatUsers.findIndex((t=>t===s.message.nickname));this.chatUsers.splice(t,1)}this.reloadUsersList()}reloadUsersList(){this.users.innerHTML="",this.chatUsers.forEach((s=>{const t=document.createElement("li");t.classList.add("chat__user"),t.innerHTML=`\n        <div class="chat-user__icon"></div>\n        <div class="chat-user__name">${s}</div>\n      `,this.users.appendChild(t)}));const s=document.createElement("li");s.classList.add("chat__user"),s.innerHTML='\n      <div class="chat-user__icon"></div>\n      <div class="chat-user__name chat-user-name__you">Вы</div>\n    ',this.users.appendChild(s)}}(".chat").bindToDOM()})();